<!DOCTYPE html>
<html>
<head>
    <title>TaskForge HITL</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: #4CAF50; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .task { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; border-left: 5px solid #f44336; }
        .task.approved { border-left-color: #4CAF50; background: #f0fff0; }
        .task-title { font-weight: bold; margin-bottom: 10px; }
        .task-meta { color: #666; margin-bottom: 10px; }
        .task-actions { text-align: right; margin-top: 15px; }
        button { padding: 8px 16px; margin: 0 5px; border: none; border-radius: 4px; cursor: pointer; }
        .approve { background: #4CAF50; color: white; }
        .reject { background: #f44336; color: white; }
        .submit { background: #2196F3; color: white; padding: 15px 30px; font-size: 16px; margin: 20px auto; display: block; }
        .counter { position: fixed; top: 20px; right: 20px; background: #2196F3; color: white; padding: 10px; border-radius: 5px; }
        .loading { text-align: center; padding: 50px; }
        .success { background: #d4edda; color: #155724; padding: 20px; text-align: center; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="counter">Approved: <span id="count">0</span>/<span id="total">0</span></div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ TaskForge HITL Approval</h1>
            <p id="meetingTitle">Loading...</p>
        </div>
        
        <div id="loading" class="loading">
            <h3>‚è≥ Loading tasks...</h3>
            <p>Waiting for task data from N8N...</p>
        </div>
        
        <div id="content" style="display: none;">
            <div id="tasks"></div>
            <button class="submit" onclick="submit()">üíæ Submit to TaskForge</button>
        </div>
        
        <div id="success" style="display: none;" class="success">
            <h2>‚úÖ Success!</h2>
            <p>Tasks have been submitted to TaskForge.</p>
            <p>This page will close automatically.</p>
        </div>
    </div>

    <script>
        let tasks = [];
        let webhookUrl = 'https://levirybalov.app.n8n.cloud/webhook/3142af19-c362-47fc-b046-5e1d2b3882b9';

        // Listen for task data from N8N (via postMessage or URL)
        window.addEventListener('message', function(event) {
            if (event.data && event.data.tasks) {
                loadTasks(event.data);
            }
        });

        // Check URL parameters for task data
        function checkUrlData() {
            const params = new URLSearchParams(window.location.search);
            const tasksParam = params.get('tasks');
            const titleParam = params.get('title');
            
            if (tasksParam) {
                try {
                    const taskData = {
                        tasks: JSON.parse(decodeURIComponent(tasksParam)),
                        meeting_title: titleParam || 'TaskForge Meeting',
                        webhook_url: params.get('webhook') || webhookUrl
                    };
                    loadTasks(taskData);
                    return true;
                } catch (e) {
                    console.error('Error parsing URL data:', e);
                }
            }
            return false;
        }

        // Load demo data if no real data
        function loadDemoData() {
            setTimeout(() => {
                const demoData = {
                    meeting_title: 'TaskForge Demo Meeting',
                    webhook_url: webhookUrl,
                    tasks: [
                        {
                            task_id: 'demo_1',
                            task_item: 'Review new Python SDK changes',
                            assignee_full_names: 'Yang Zheng',
                            assignee_emails: 'yang@coophive.network',
                            priority: 'High',
                            brief_description: 'Yang needs to review the Python SDK changes submitted at midnight.',
                            date_expected: '2025-07-26'
                        },
                        {
                            task_id: 'demo_2', 
                            task_item: 'Provide cost breakdown analysis',
                            assignee_full_names: 'Bryan Bui',
                            assignee_emails: 'bryan@example.com',
                            priority: 'Medium',
                            brief_description: 'Bryan needs to provide detailed cost breakdown with justifications.',
                            date_expected: '2025-07-25'
                        }
                    ]
                };
                loadTasks(demoData);
            }, 2000);
        }

        function loadTasks(data) {
            tasks = data.tasks.map(t => ({...t, status: 'reject'}));
            webhookUrl = data.webhook_url || webhookUrl;
            
            document.getElementById('meetingTitle').textContent = data.meeting_title || 'TaskForge Meeting';
            document.getElementById('total').textContent = tasks.length;
            
            const container = document.getElementById('tasks');
            container.innerHTML = tasks.map((task, i) => `
                <div class="task" id="task_${i}">
                    <div class="task-title">${task.task_item}</div>
                    <div class="task-meta">
                        üë§ ${task.assignee_full_names} | üìß ${task.assignee_emails}<br>
                        üìÖ ${task.date_expected} | üî• ${task.priority}
                    </div>
                    <div>${task.brief_description}</div>
                    <div class="task-actions">
                        <button class="reject" onclick="setAction(${i}, 'reject')">‚ùå Reject</button>
                        <button class="approve" onclick="setAction(${i}, 'approve')">‚úÖ Approve</button>
                    </div>
                </div>
            `).join('');
            
            // Show content, hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            updateCounter();
        }

        function setAction(index, action) {
            tasks[index].status = action;
            const card = document.getElementById(`task_${index}`);
            card.className = action === 'approve' ? 'task approved' : 'task';
            updateCounter();
        }

        function updateCounter() {
            const approved = tasks.filter(t => t.status === 'approve').length;
            document.getElementById('count').textContent = approved;
        }

        async function submit() {
            const approved = tasks.filter(t => t.status === 'approve');
            
            const payload = {
                approved_tasks: approved,
                approved_count: approved.length,
                total_tasks: tasks.length,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    // Show success and auto-close
                    document.getElementById('content').style.display = 'none';
                    document.getElementById('success').style.display = 'block';
                    
                    setTimeout(() => {
                        window.close();
                    }, 3000);
                } else {
                    alert('‚ùå Error submitting to TaskForge');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Initialize - check for URL data first, then demo
        if (!checkUrlData()) {
            loadDemoData();
        }

        // Expose function for N8N to call directly
        window.receiveTaskData = loadTasks;
    </script>
</body>
</html>