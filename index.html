<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskForge HITL Approval</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .stats {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }

        .meeting-group {
            border-bottom: 1px solid #eee;
        }

        .meeting-header {
            background: #f8f9fa;
            padding: 20px 30px;
            border-left: 4px solid #4CAF50;
            font-weight: 600;
            color: #2c3e50;
        }

        .task-card {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 30px;
            transition: all 0.3s ease;
        }

        .task-card.approved {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
        }

        .task-card.rejected {
            border-color: #f44336;
            background: #fff0f0;
            opacity: 0.7;
        }

        .task-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
        }

        .task-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .task-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 16px;
            background: #fdfdfd;
            border-left: 4px solid #e9ecef;
            border-radius: 4px;
        }

        .task-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-reject {
            background: #f44336;
            color: white;
        }

        .btn-approve {
            background: #4CAF50;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .submit-section {
            padding: 30px;
            background: #f8f9fa;
            text-align: center;
            border-top: 1px solid #eee;
        }

        .submit-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        .loading {
            text-align: center;
            padding: 80px 30px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 60px 30px;
            text-align: center;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 20px;
            text-align: center;
            margin: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="stats">
                <span id="approvedCount">0</span>/<span id="totalCount">0</span> Approved
            </div>
            <h1>üöÄ TaskForge HITL</h1>
            <p id="meetingTitle">Loading tasks...</p>
        </div>
        
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <h3>Loading Tasks...</h3>
        </div>
        
        <div id="content" style="display: none;">
            <div id="meetingsContainer"></div>
            
            <div class="submit-section">
                <button class="submit-btn" onclick="submitApprovals()">
                    üíæ Submit to TaskForge
                </button>
            </div>
        </div>
        
        <div id="success" class="success" style="display: none;">
            <h2>‚úÖ Success!</h2>
            <p>Your approved tasks have been submitted to TaskForge.</p>
            <p>This window will close automatically in 3 seconds.</p>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <h3>‚ùå Error</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <script>
        let tasksByMeeting = {};
        let webhookUrl = 'https://levirybalov.app.n8n.cloud/webhook/3142af19-c362-47fc-b046-5e1d2b3882b9';
        let totalTasks = 0;

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                tasks: params.get('tasks'),
                title: params.get('title'),
                webhook: params.get('webhook'),
                exec_id: params.get('exec_id')
            };
        }

        function fixEncoding(text) {
            if (!text) return '';
            try {
                return text
                    .replace(/√¢‚Ç¨‚Ñ¢/g, "'")
                    .replace(/√¢‚Ç¨≈ì/g, '"')
                    .replace(/√¢‚Ç¨/g, '"')
                    .replace(/√¢‚Ç¨"/g, '‚Äì')
                    .replace(/√¢‚Ç¨"/g, '‚Äî')
                    .replace(/√∞≈∏"¬•/g, 'üî•')
                    .replace(/√∞≈∏'¬§/g, 'üë§')
                    .replace(/√∞≈∏"¬ß/g, 'üìß')
                    .replace(/√∞≈∏"‚Ä¶/g, 'üìÖ');
            } catch (e) {
                return text;
            }
        }

        function groupTasksByMeeting(tasks) {
            const grouped = {};
            
            tasks.forEach(task => {
                // Use actual meeting data from the task
                const meetingId = task.meeting_id || task.meeting_title || `meeting_${task.task_id.split('_')[1]}` || 'default_meeting';
                const meetingTitle = task.meeting_title || 'TaskForge Meeting';
                const meetingOrganizer = task.meeting_organizer || task.organizer_email || 'Unknown';
                const meetingDate = task.meeting_date || task.date || new Date().toISOString();
                
                if (!grouped[meetingId]) {
                    grouped[meetingId] = {
                        title: fixEncoding(meetingTitle),
                        organizer: meetingOrganizer,
                        date: meetingDate,
                        tasks: []
                    };
                }
                
                const cleanTask = {
                    ...task,
                    task_item: fixEncoding(task.task_item),
                    brief_description: fixEncoding(task.brief_description),
                    assignee_full_names: fixEncoding(task.assignee_full_names),
                    status: 'pending'
                };
                
                grouped[meetingId].tasks.push(cleanTask);
            });
            
            return grouped;
        }

        function renderMeetings() {
            const container = document.getElementById('meetingsContainer');
            container.innerHTML = '';
            
            Object.entries(tasksByMeeting).forEach(([meetingId, meeting]) => {
                const meetingDiv = document.createElement('div');
                meetingDiv.className = 'meeting-group';
                meetingDiv.innerHTML = `
                    <div class="meeting-header">
                        <div style="font-size: 1.4rem; margin-bottom: 8px;">${meeting.title}</div>
                        <div style="color: #7f8c8d; font-size: 0.9rem;">
                            üìÖ ${new Date(meeting.date).toLocaleDateString()} ‚Ä¢ 
                            üë§ ${meeting.organizer} ‚Ä¢ 
                            üìã ${meeting.tasks.length} tasks
                        </div>
                    </div>
                    ${meeting.tasks.map((task, index) => renderTask(task, meetingId, index)).join('')}
                `;
                container.appendChild(meetingDiv);
            });
        }

        function renderTask(task, meetingId, taskIndex) {
            const taskId = `${meetingId}_${taskIndex}`;
            
            return `
                <div class="task-card" id="task_${taskId}">
                    <div class="task-title">${task.task_item}</div>
                    
                    <div class="task-meta">
                        <div>üë§ ${task.assignee_full_names}</div>
                        <div>üìß ${task.assignee_emails}</div>
                        <div>üìÖ ${task.date_expected}</div>
                        <div>üî• ${task.priority} Priority</div>
                    </div>
                    
                    <div class="task-description">
                        ${task.brief_description}
                    </div>
                    
                    <div class="task-actions">
                        <button class="btn btn-reject" onclick="setTaskStatus('${meetingId}', ${taskIndex}, 'reject')">
                            ‚ùå Reject
                        </button>
                        <button class="btn btn-approve" onclick="setTaskStatus('${meetingId}', ${taskIndex}, 'approve')">
                            ‚úÖ Approve
                        </button>
                    </div>
                </div>
            `;
        }

        function setTaskStatus(meetingId, taskIndex, status) {
            const task = tasksByMeeting[meetingId].tasks[taskIndex];
            task.status = status;
            
            const taskId = `${meetingId}_${taskIndex}`;
            const taskElement = document.getElementById(`task_${taskId}`);
            taskElement.className = `task-card ${status === 'approve' ? 'approved' : 'rejected'}`;
            
            updateStats();
        }

        function updateStats() {
            let approved = 0;
            Object.values(tasksByMeeting).forEach(meeting => {
                meeting.tasks.forEach(task => {
                    if (task.status === 'approve') approved++;
                });
            });
            
            document.getElementById('approvedCount').textContent = approved;
        }

        async function loadTasksFromServer(execId) {
            try {
                console.log('üì° Fetching tasks from server...');
                const response = await fetch(`/get-tasks/${execId}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load tasks: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Received data:', data);
                
                if (data.tasks && data.tasks.length > 0) {
                    totalTasks = data.tasks.length;
                    document.getElementById('totalCount').textContent = totalTasks;
                    document.getElementById('meetingTitle').textContent = fixEncoding(data.meeting_title || 'TaskForge Meeting');
                    
                    tasksByMeeting = groupTasksByMeeting(data.tasks);
                    renderMeetings();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                } else {
                    throw new Error('No tasks found in server response');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load tasks from server:', error);
                document.getElementById('errorMessage').textContent = `Failed to load tasks: ${error.message}`;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        async function submitApprovals() {
            console.log('üöÄ Starting submission process...');
            
            const params = getUrlParams();
            const approvedTasks = [];
            
            Object.entries(tasksByMeeting).forEach(([meetingId, meeting]) => {
                meeting.tasks.forEach(task => {
                    if (task.status === 'approve') {
                        approvedTasks.push({
                            ...task,
                            meeting_context: {
                                id: meetingId,
                                title: meeting.title,
                                organizer: meeting.organizer,
                                date: meeting.date
                            },
                            approved_at: new Date().toISOString()
                        });
                    }
                });
            });

            console.log(`üìä Found ${approvedTasks.length} approved tasks out of ${totalTasks} total`);

            if (approvedTasks.length === 0) {
                alert('Please approve at least one task before submitting.');
                return;
            }

            try {
                const payload = {
                    execution_id: params.exec_id || `hitl_${Date.now()}`,
                    approved_tasks: approvedTasks,
                    approved_count: approvedTasks.length,
                    total_tasks: totalTasks,
                    timestamp: new Date().toISOString(),
                    source: 'TaskForge_HITL_Dashboard'
                };

                console.log('üì§ Submitting to server-side proxy');
                console.log('üìã Payload:', payload);

                // Show loading state
                const submitBtn = document.querySelector('.submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Submitting...';
                submitBtn.disabled = true;

                // NEW: Submit to our own server's approval endpoint
                const response = await fetch('/submit-approval', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('‚úÖ Success response:', responseData);
                    
                    // Self-destruct UI
                    document.body.innerHTML = '<div style="text-align:center;padding:50px;background:#4CAF50;color:white;"><h2>‚úÖ Tasks Submitted!</h2><p>This link has expired and cannot be used again.</p><p>n8n will process your approved tasks shortly.</p></div>';
                    
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Server error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('‚ùå Submit error:', error);
                
                // Reset button
                const submitBtn = document.querySelector('.submit-btn');
                submitBtn.textContent = 'üíæ Submit to TaskForge';
                submitBtn.disabled = false;
                
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        function init() {
            const params = getUrlParams();
            
            if (params.webhook) {
                const raw = decodeURIComponent(params.webhook);
                // Force production path even if someone supplied the test URL
                webhookUrl = raw.replace('/webhook-test/', '/webhook/');
            }
            
            if (params.title) {
                document.getElementById('meetingTitle').textContent = fixEncoding(decodeURIComponent(params.title));
            }

            // NEW: Check if we have exec_id (HTTP request approach)
            if (params.exec_id && !params.tasks) {
                console.log('üîÑ Loading tasks from server using exec_id:', params.exec_id);
                loadTasksFromServer(params.exec_id);
            } else if (params.tasks) {
                // Original method with tasks in URL
                try {
                    const tasks = JSON.parse(decodeURIComponent(params.tasks));
                    totalTasks = tasks.length;
                    
                    document.getElementById('totalCount').textContent = totalTasks;
                    
                    tasksByMeeting = groupTasksByMeeting(tasks);
                    renderMeetings();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                    
                } catch (error) {
                    console.error('Failed to parse tasks:', error);
                    document.getElementById('errorMessage').textContent = 'Failed to load tasks. Invalid data format.';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                }
            } else {
                loadDemoData();
            }
        }

        function loadDemoData() {
            setTimeout(() => {
                const demoTasks = [
                    {
                        task_id: 'demo_1',
                        task_item: 'Review Python SDK Changes',
                        assignee_full_names: 'Yang Zheng',
                        assignee_emails: 'yang@coophive.network',
                        priority: 'High',
                        brief_description: 'Yang needs to review the Python SDK changes submitted at midnight.',
                        date_expected: '2025-07-26',
                        meeting_id: 'meeting_1',
                        meeting_title: 'CoopHive Development Sync',
                        meeting_organizer: 'Levi Rybalov'
                    },
                    {
                        task_id: 'demo_2',
                        task_item: 'Provide Cost Breakdown',
                        assignee_full_names: 'Bryan Bui',
                        assignee_emails: 'bryan@var-meta.com',
                        priority: 'Medium',
                        brief_description: 'Bryan needs to provide detailed cost breakdown with justifications.',
                        date_expected: '2025-07-25',
                        meeting_id: 'meeting_1',
                        meeting_title: 'CoopHive Development Sync',
                        meeting_organizer: 'Levi Rybalov'
                    }
                ];
                
                totalTasks = demoTasks.length;
                document.getElementById('totalCount').textContent = totalTasks;
                
                tasksByMeeting = groupTasksByMeeting(demoTasks);
                renderMeetings();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }, 1000);
        }

        init();
    </script>
</body>
</html> 