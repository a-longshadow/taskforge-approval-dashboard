<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskForge HITL Approval Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .progress-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .progress-bar-container {
            background: #e9ecef;
            border-radius: 25px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            border-radius: 25px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: bold;
            color: #495057;
        }
        
        .meetings-container {
            padding: 30px;
        }
        
        .meeting-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .meeting-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .meeting-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .meeting-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .meeting-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .meeting-meta {
            color: #6c757d;
            font-size: 0.95em;
        }
        
        .meeting-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .meeting-stat {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid #dee2e6;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .bulk-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bulk-approve {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .bulk-approve:hover {
            background: linear-gradient(135deg, #218838, #1c9b7e);
            transform: translateY(-2px);
        }
        
        .bulk-reject {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .bulk-reject:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
            transform: translateY(-2px);
        }
        
        .tasks-container {
            padding: 0;
        }
        
        .task-item {
            border-bottom: 1px solid #f1f3f4;
            padding: 20px 25px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-item:hover {
            background: #f8f9fa;
        }
        
        .task-item.approved {
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
            border-left: 4px solid #28a745;
        }
        
        .task-item.rejected {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1), rgba(200, 35, 51, 0.1));
            border-left: 4px solid #dc3545;
        }
        
        .task-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }
        
        .task-details {
            flex: 1;
        }
        
        .task-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .task-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .task-description {
            color: #6c757d;
            font-size: 0.95em;
            line-height: 1.5;
            margin-top: 10px;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            align-items: flex-start;
        }
        
        .task-btn {
            padding: 10px 20px;
            border: 2px solid;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: center;
        }
        
        .task-approve {
            border-color: #28a745;
            color: #28a745;
            background: white;
        }
        
        .task-approve:hover, .task-approve.active {
            background: #28a745;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .task-reject {
            border-color: #dc3545;
            color: #dc3545;
            background: white;
        }
        
        .task-reject:hover, .task-reject.active {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .priority-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .priority-high {
            background: #fff5f5;
            color: #c53030;
            border: 1px solid #fed7d7;
        }
        
        .priority-medium {
            background: #fffbf0;
            color: #d69e2e;
            border: 1px solid #feebc8;
        }
        
        .priority-low {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #c6f6d5;
        }
        
        .submit-section {
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        .timeout-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .progress-stats {
                justify-content: center;
            }
            
            .task-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .task-actions {
                align-self: stretch;
                justify-content: center;
            }
            
            .meeting-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .bulk-actions {
                justify-content: center;
            }
        }

        /* Waiting State Styles */
        .waiting-state {
            text-align: center;
            padding: 80px 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            margin: 40px;
            border: 2px dashed #6c757d;
        }

        .waiting-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .waiting-state h2 {
            color: #495057;
            margin-bottom: 16px;
            font-size: 1.5rem;
        }

        .waiting-state p {
            color: #6c757d;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .waiting-details {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            display: inline-block;
            text-align: left;
        }

        .waiting-details div {
            margin: 8px 0;
            color: #495057;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔥 TaskForge HITL Approval</h1>
            <p id="header-subtitle">Loading task data...</p>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading your tasks...</p>
        </div>
        
        <div id="main-content" style="display: none;">
            <div class="progress-section">
                <div class="timeout-warning" id="timeout-warning" style="display: none;">
                    ⏰ <strong>Time Sensitive:</strong> This approval will auto-submit in <span id="countdown">15:00</span> minutes
                </div>
                
                <div class="progress-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-meetings">0</div>
                        <div class="stat-label">Meetings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-tasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="approved-count">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="rejected-count">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pending-count">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                    <div class="progress-text" id="progress-text">0% Complete</div>
                </div>
            </div>
            
            <div class="meetings-container" id="meetings-container">
                <!-- Meeting cards will be dynamically generated here -->
            </div>
            
            <div class="submit-section">
                <button class="submit-btn" id="submit-btn" onclick="submitApproval()">
                    💾 Save Changes & Submit to N8N
                </button>
                <p style="margin-top: 15px; color: #6c757d; font-size: 0.9em;">
                    Only approved tasks will be sent to Monday.com
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let taskData = null;
        let taskStates = {}; // Track individual task approval states
        let countdownTimer = null;
        let timeoutMinutes = 15;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const execId = urlParams.get('exec_id');
            
            if (!execId) {
                // Production behavior: Show waiting state instead of error
                showWaitingState();
                return;
            }
            
            loadTaskData(execId);
        });
        
        // Load task data from server
        async function loadTaskData(execId) {
            try {
                showLoading(true);
                
                const response = await fetch(`/get-tasks/${execId}`);
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                taskData = await response.json();
                initializeTaskStates();
                renderUI();
                startCountdown();
                showLoading(false);
                
                showNotification('Tasks loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                showNotification(`Failed to load tasks: ${error.message}`, 'error');
                showLoading(false);
            }
        }
        
        // Initialize task states tracking
        function initializeTaskStates() {
            taskStates = {};
            
            if (taskData.meetings) {
                taskData.meetings.forEach(meeting => {
                    meeting.tasks.forEach((task, index) => {
                        const taskId = `${meeting.meeting_id}_${index}`;
                        taskStates[taskId] = {
                            approved: false,
                            rejected: false,
                            task: task,
                            meetingId: meeting.meeting_id
                        };
                    });
                });
            }
            
            updateStatistics();
        }
        
        // Render the complete UI
        function renderUI() {
            if (!taskData || !taskData.meetings) {
                showNotification('No meeting data found', 'error');
                return;
            }
            
            // Update header
            document.getElementById('header-subtitle').textContent = 
                `${taskData.meetings.length} meetings • ${taskData.total_tasks || 0} tasks • Execution: ${taskData.execution_id}`;
            
            // Show timeout warning
            document.getElementById('timeout-warning').style.display = 'block';
            
            // Render meetings
            const container = document.getElementById('meetings-container');
            container.innerHTML = '';
            
            taskData.meetings.forEach((meeting, meetingIndex) => {
                const meetingCard = createMeetingCard(meeting, meetingIndex);
                container.appendChild(meetingCard);
            });
            
            updateStatistics();
        }
        
        // Create individual meeting card
        function createMeetingCard(meeting, meetingIndex) {
            const card = document.createElement('div');
            card.className = 'meeting-card';
            card.innerHTML = `
                <div class="meeting-header">
                    <div class="meeting-title">
                        📋 ${meeting.meeting_title}
                        <span class="priority-badge priority-high">${meeting.tasks.length} Tasks</span>
                    </div>
                    <div class="meeting-info">
                        <div class="meeting-meta">
                            <div>👤 <strong>Organizer:</strong> ${meeting.meeting_organizer}</div>
                            <div>📅 <strong>Date:</strong> ${new Date(parseInt(meeting.meeting_date)).toLocaleDateString()}</div>
                            <div>🆔 <strong>ID:</strong> ${meeting.meeting_id}</div>
                        </div>
                        <div class="meeting-stats">
                            <div class="meeting-stat">
                                ✅ <span id="meeting-approved-${meetingIndex}">0</span> Approved
                            </div>
                            <div class="meeting-stat">
                                ❌ <span id="meeting-rejected-${meetingIndex}">0</span> Rejected
                            </div>
                            <div class="meeting-stat">
                                ⏳ <span id="meeting-pending-${meetingIndex}">${meeting.tasks.length}</span> Pending
                            </div>
                        </div>
                    </div>
                    <div class="bulk-actions">
                        <button class="bulk-btn bulk-approve" onclick="bulkAction('${meeting.meeting_id}', true)">
                            ✅ Approve All ${meeting.tasks.length} Tasks
                        </button>
                        <button class="bulk-btn bulk-reject" onclick="bulkAction('${meeting.meeting_id}', false)">
                            ❌ Reject All ${meeting.tasks.length} Tasks
                        </button>
                    </div>
                </div>
                <div class="tasks-container">
                    ${meeting.tasks.map((task, taskIndex) => createTaskItem(task, meeting.meeting_id, taskIndex, meetingIndex)).join('')}
                </div>
            `;
            
            return card;
        }
        
        // Create individual task item
        function createTaskItem(task, meetingId, taskIndex, meetingIndex) {
            const taskId = `${meetingId}_${taskIndex}`;
            const priorityClass = `priority-${(task.priority || 'medium').toLowerCase()}`;
            
            return `
                <div class="task-item" id="task-${taskId}" data-task-id="${taskId}">
                    <div class="task-content">
                        <div class="task-details">
                            <div class="task-title">${task.task_item}</div>
                            <div class="task-meta">
                                <span>👤 ${task['assignee(s)_full_names']}</span>
                                <span>📧 ${task.assignee_emails}</span>
                                <span>📅 ${task.date_expected}</span>
                                <span class="priority-badge ${priorityClass}">${task.priority || 'Medium'}</span>
                            </div>
                            <div class="task-description">${task.brief_description}</div>
                        </div>
                        <div class="task-actions">
                            <button class="task-btn task-approve" 
                                    id="approve-${taskId}"
                                    onclick="toggleTaskState('${taskId}', true)">
                                ✅ Approve
                            </button>
                            <button class="task-btn task-reject" 
                                    id="reject-${taskId}"
                                    onclick="toggleTaskState('${taskId}', false)">
                                ❌ Reject
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Toggle individual task state
        function toggleTaskState(taskId, approve) {
            if (!taskStates[taskId]) return;
            
            const taskState = taskStates[taskId];
            const taskElement = document.getElementById(`task-${taskId}`);
            const approveBtn = document.getElementById(`approve-${taskId}`);
            const rejectBtn = document.getElementById(`reject-${taskId}`);
            
            if (approve) {
                // Approve this task
                taskState.approved = !taskState.approved;
                taskState.rejected = false;
                
                approveBtn.classList.toggle('active', taskState.approved);
                rejectBtn.classList.remove('active');
                
                taskElement.className = 'task-item' + (taskState.approved ? ' approved' : '');
                
            } else {
                // Reject this task
                taskState.rejected = !taskState.rejected;
                taskState.approved = false;
                
                rejectBtn.classList.toggle('active', taskState.rejected);
                approveBtn.classList.remove('active');
                
                taskElement.className = 'task-item' + (taskState.rejected ? ' rejected' : '');
            }
            
            updateStatistics();
            
            // Show feedback
            const action = approve ? (taskState.approved ? 'approved' : 'unmarked') : (taskState.rejected ? 'rejected' : 'unmarked');
            showNotification(`Task ${action}`, 'info', 1000);
        }
        
        // Bulk approve/reject for a meeting
        function bulkAction(meetingId, approve) {
            let count = 0;
            
            Object.keys(taskStates).forEach(taskId => {
                if (taskStates[taskId].meetingId === meetingId) {
                    const taskState = taskStates[taskId];
                    const taskElement = document.getElementById(`task-${taskId}`);
                    const approveBtn = document.getElementById(`approve-${taskId}`);
                    const rejectBtn = document.getElementById(`reject-${taskId}`);
                    
                    if (approve) {
                        taskState.approved = true;
                        taskState.rejected = false;
                        approveBtn.classList.add('active');
                        rejectBtn.classList.remove('active');
                        taskElement.className = 'task-item approved';
                    } else {
                        taskState.approved = false;
                        taskState.rejected = true;
                        approveBtn.classList.remove('active');
                        rejectBtn.classList.add('active');
                        taskElement.className = 'task-item rejected';
                    }
                    count++;
                }
            });
            
            updateStatistics();
            
            const action = approve ? 'approved' : 'rejected';
            showNotification(`${count} tasks ${action} for this meeting`, 'success');
        }
        
        // Update all statistics and progress
        function updateStatistics() {
            let totalTasks = 0;
            let approvedCount = 0;
            let rejectedCount = 0;
            let pendingCount = 0;
            
            // Count overall statistics
            Object.values(taskStates).forEach(state => {
                totalTasks++;
                if (state.approved) {
                    approvedCount++;
                } else if (state.rejected) {
                    rejectedCount++;
                } else {
                    pendingCount++;
                }
            });
            
            // Update global stats
            document.getElementById('total-meetings').textContent = taskData.meetings.length;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('approved-count').textContent = approvedCount;
            document.getElementById('rejected-count').textContent = rejectedCount;
            document.getElementById('pending-count').textContent = pendingCount;
            
            // Update progress bar
            const progressPercent = totalTasks > 0 ? Math.round((approvedCount + rejectedCount) / totalTasks * 100) : 0;
            document.getElementById('progress-bar').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = `${progressPercent}% Complete (${approvedCount} approved)`;
            
            // Update per-meeting statistics
            taskData.meetings.forEach((meeting, meetingIndex) => {
                let meetingApproved = 0;
                let meetingRejected = 0;
                let meetingPending = 0;
                
                meeting.tasks.forEach((task, taskIndex) => {
                    const taskId = `${meeting.meeting_id}_${taskIndex}`;
                    const state = taskStates[taskId];
                    
                    if (state.approved) meetingApproved++;
                    else if (state.rejected) meetingRejected++;
                    else meetingPending++;
                });
                
                const approvedEl = document.getElementById(`meeting-approved-${meetingIndex}`);
                const rejectedEl = document.getElementById(`meeting-rejected-${meetingIndex}`);
                const pendingEl = document.getElementById(`meeting-pending-${meetingIndex}`);
                
                if (approvedEl) approvedEl.textContent = meetingApproved;
                if (rejectedEl) rejectedEl.textContent = meetingRejected;
                if (pendingEl) pendingEl.textContent = meetingPending;
            });
        }
        
        // Submit approval to N8N
        async function submitApproval() {
            const approvedTasks = [];
            
            // Collect only approved tasks
            Object.values(taskStates).forEach(state => {
                if (state.approved) {
                    approvedTasks.push({
                        ...state.task,
                        approved: true,
                        processed_at: new Date().toISOString()
                    });
                }
            });
            
            if (approvedTasks.length === 0) {
                showNotification('No tasks approved. Please approve at least one task.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Submitting...';
            
            try {
                const payload = {
                    execution_id: taskData.execution_id,
                    monday_tasks_with_approval: approvedTasks,
                    approved_count: approvedTasks.length,
                    total_tasks: Object.keys(taskStates).length,
                    timestamp: new Date().toISOString(),
                    source: 'TaskForge_HITL_Individual_Approval'
                };
                
                const response = await fetch('/submit-approval', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                showNotification(`✅ Success! ${approvedTasks.length} approved tasks sent to N8N`, 'success');
                
                // Clear countdown
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }
                
                // EXTINGUISH UI - Replace everything with success message
                extinguishUI(approvedTasks.length);
                
            } catch (error) {
                console.error('Submission error:', error);
                showNotification(`Failed to submit: ${error.message}`, 'error');
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '💾 Save Changes & Submit to N8N';
            }
        }
        
        // Start countdown timer
        function startCountdown() {
            let totalSeconds = timeoutMinutes * 60;
            
            countdownTimer = setInterval(() => {
                totalSeconds--;
                
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('countdown').textContent = timeString;
                
                if (totalSeconds <= 0) {
                    clearInterval(countdownTimer);
                    autoSubmit();
                }
            }, 1000);
        }
        
        // Auto-submit when timeout reached
        function autoSubmit() {
            showNotification('⏰ Time expired! Auto-approving all tasks...', 'info');
            
            // Auto-approve all tasks
            Object.keys(taskStates).forEach(taskId => {
                taskStates[taskId].approved = true;
                taskStates[taskId].rejected = false;
            });
            
            updateStatistics();
            submitApproval();
        }
        
        // Show/hide loading state
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('main-content').style.display = show ? 'none' : 'block';
        }
        
        // Show notification
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, duration);
        }
        
        // Extinguish UI after successful submission
        function extinguishUI(approvedCount) {
            // Replace entire page content with success message
            document.body.innerHTML = `
                <div style="
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    min-height: 100vh;
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    text-align: center;
                    padding: 20px;
                ">
                    <div style="
                        background: rgba(255, 255, 255, 0.1);
                        padding: 60px 40px;
                        border-radius: 20px;
                        backdrop-filter: blur(10px);
                        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
                        max-width: 600px;
                    ">
                        <div style="font-size: 4rem; margin-bottom: 20px;">✅</div>
                        <h1 style="font-size: 2.5rem; margin-bottom: 20px; font-weight: 700;">
                            Tasks Submitted Successfully!
                        </h1>
                        <p style="font-size: 1.3rem; margin-bottom: 15px; opacity: 0.9;">
                            ${approvedCount} approved tasks have been sent to N8N
                        </p>
                        <p style="font-size: 1.1rem; opacity: 0.8; margin-bottom: 30px;">
                            Your Monday.com integration will process these tasks shortly.
                        </p>
                        <div style="
                            background: rgba(255, 255, 255, 0.2);
                            padding: 20px;
                            border-radius: 10px;
                            font-size: 0.95rem;
                            opacity: 0.7;
                        ">
                            🔒 This approval session has been completed and cannot be used again.<br>
                            The data has been securely processed and removed from the system.
                        </div>
                    </div>
                </div>
            `;
        }

        // Show waiting state when no execution ID is provided
        function showWaitingState() {
            showLoading(false);
            
            const container = document.getElementById('meetings-container');
            container.innerHTML = `
                <div class="waiting-state">
                    <div class="waiting-icon">⏳</div>
                    <h2>Waiting for N8N Workflow Data</h2>
                    <p>This TaskForge HITL dashboard is ready and listening.</p>
                    <p>No active execution found. Please run your N8N workflow to send task data.</p>
                    <div class="waiting-details">
                        <div>🔗 <strong>Endpoint:</strong> /store-tasks</div>
                        <div>📡 <strong>Status:</strong> Ready to receive</div>
                        <div>⚡ <strong>Auto-refresh:</strong> Every 30 seconds</div>
                    </div>
                </div>
            `;
            
            // Hide submit section
            document.querySelector('.submit-section').style.display = 'none';
            
            // Update header
            document.getElementById('header-subtitle').textContent = 'Ready to receive N8N workflow data';
            
            // Auto-refresh every 30 seconds to check for new data
            setTimeout(() => {
                window.location.reload();
            }, 30000);
        }
    </script>
</body>
</html> 